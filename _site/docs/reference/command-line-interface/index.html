<h1>MCP Protocol Reference</h1>
<p>Technical reference for the Model Context Protocol implementation in documcp.</p>
<h2>Overview</h2>
<p>documcp implements the MCP (Model Context Protocol) specification for seamless integration with AI clients. This reference covers protocol messages, handshakes, and error handling.</p>
<h2>Protocol Basics</h2>
<h3>Transport Layer</h3>
<p>documcp uses <strong>stdio transport</strong> for MCP communication:</p>
<pre><code class="language-json">{
  &quot;transport&quot;: &quot;stdio&quot;,
  &quot;command&quot;: &quot;node&quot;,
  &quot;args&quot;: [&quot;/path/to/documcp/dist/index.js&quot;]
}
</code></pre>
<h3>Message Format</h3>
<p>All MCP messages follow JSON-RPC 2.0 specification:</p>
<pre><code class="language-typescript">interface MCPMessage {
  jsonrpc: &quot;2.0&quot;;
  id?: string | number;
  method: string;
  params?: object;
}
</code></pre>
<h2>Initialization Handshake</h2>
<h3>1. Initialize Request</h3>
<p>Client sends initialization request:</p>
<pre><code class="language-json">{
  &quot;jsonrpc&quot;: &quot;2.0&quot;,
  &quot;id&quot;: 1,
  &quot;method&quot;: &quot;initialize&quot;,
  &quot;params&quot;: {
    &quot;protocolVersion&quot;: &quot;2024-11-05&quot;,
    &quot;capabilities&quot;: {
      &quot;roots&quot;: {
        &quot;listChanged&quot;: true
      },
      &quot;sampling&quot;: {}
    },
    &quot;clientInfo&quot;: {
      &quot;name&quot;: &quot;Claude Desktop&quot;,
      &quot;version&quot;: &quot;0.7.0&quot;
    }
  }
}
</code></pre>
<h3>2. Initialize Response</h3>
<p>documcp responds with server capabilities:</p>
<pre><code class="language-json">{
  &quot;jsonrpc&quot;: &quot;2.0&quot;,
  &quot;id&quot;: 1,
  &quot;result&quot;: {
    &quot;protocolVersion&quot;: &quot;2024-11-05&quot;,
    &quot;capabilities&quot;: {
      &quot;tools&quot;: {
        &quot;listChanged&quot;: true
      },
      &quot;logging&quot;: {}
    },
    &quot;serverInfo&quot;: {
      &quot;name&quot;: &quot;documcp&quot;,
      &quot;version&quot;: &quot;1.0.0&quot;
    }
  }
}
</code></pre>
<h3>3. Initialized Notification</h3>
<p>Client confirms initialization:</p>
<pre><code class="language-json">{
  &quot;jsonrpc&quot;: &quot;2.0&quot;,
  &quot;method&quot;: &quot;notifications/initialized&quot;
}
</code></pre>
<h2>Core Protocol Methods</h2>
<h3>tools/list</h3>
<p>Lists available MCP tools:</p>
<p><strong>Request:</strong></p>
<pre><code class="language-json">{
  &quot;jsonrpc&quot;: &quot;2.0&quot;,
  &quot;id&quot;: 2,
  &quot;method&quot;: &quot;tools/list&quot;
}
</code></pre>
<p><strong>Response:</strong></p>
<pre><code class="language-json">{
  &quot;jsonrpc&quot;: &quot;2.0&quot;,
  &quot;id&quot;: 2,
  &quot;result&quot;: {
    &quot;tools&quot;: [
      {
        &quot;name&quot;: &quot;analyze_repository&quot;,
        &quot;description&quot;: &quot;Analyze repository structure and documentation needs&quot;,
        &quot;inputSchema&quot;: {
          &quot;type&quot;: &quot;object&quot;,
          &quot;properties&quot;: {
            &quot;path&quot;: {
              &quot;type&quot;: &quot;string&quot;,
              &quot;description&quot;: &quot;Repository path to analyze&quot;
            },
            &quot;depth&quot;: {
              &quot;type&quot;: &quot;string&quot;,
              &quot;enum&quot;: [&quot;quick&quot;, &quot;standard&quot;, &quot;deep&quot;],
              &quot;description&quot;: &quot;Analysis depth&quot;
            }
          },
          &quot;required&quot;: [&quot;path&quot;]
        }
      }
    ]
  }
}
</code></pre>
<h3>tools/call</h3>
<p>Executes a specific tool:</p>
<p><strong>Request:</strong></p>
<pre><code class="language-json">{
  &quot;jsonrpc&quot;: &quot;2.0&quot;,
  &quot;id&quot;: 3,
  &quot;method&quot;: &quot;tools/call&quot;,
  &quot;params&quot;: {
    &quot;name&quot;: &quot;analyze_repository&quot;,
    &quot;arguments&quot;: {
      &quot;path&quot;: &quot;./my-project&quot;,
      &quot;depth&quot;: &quot;standard&quot;
    }
  }
}
</code></pre>
<p><strong>Response:</strong></p>
<pre><code class="language-json">{
  &quot;jsonrpc&quot;: &quot;2.0&quot;,
  &quot;id&quot;: 3,
  &quot;result&quot;: {
    &quot;content&quot;: [
      {
        &quot;type&quot;: &quot;text&quot;,
        &quot;text&quot;: &quot;Repository analysis results...&quot;
      }
    ]
  }
}
</code></pre>
<h2>Tool Schema Validation</h2>
<h3>Zod Schema Integration</h3>
<p>documcp uses Zod for runtime validation:</p>
<pre><code class="language-typescript">import { z } from 'zod';

const AnalyzeRepositorySchema = z.object({
  path: z.string().min(1).describe('Repository path to analyze'),
  depth: z.enum(['quick', 'standard', 'deep']).optional().default('standard')
});

export type AnalyzeRepositoryArgs = z.infer&lt;typeof AnalyzeRepositorySchema&gt;;
</code></pre>
<h3>Schema to JSON Schema Conversion</h3>
<p>Zod schemas are converted to JSON Schema for MCP:</p>
<pre><code class="language-typescript">import { zodToJsonSchema } from 'zod-to-json-schema';

const jsonSchema = zodToJsonSchema(AnalyzeRepositorySchema, {
  name: 'AnalyzeRepositorySchema',
  description: 'Parameters for repository analysis'
});
</code></pre>
<h2>Error Handling</h2>
<h3>Standard Error Response</h3>
<pre><code class="language-json">{
  &quot;jsonrpc&quot;: &quot;2.0&quot;,
  &quot;id&quot;: 4,
  &quot;error&quot;: {
    &quot;code&quot;: -32602,
    &quot;message&quot;: &quot;Invalid params&quot;,
    &quot;data&quot;: {
      &quot;details&quot;: &quot;Validation failed for parameter 'path'&quot;
    }
  }
}
</code></pre>
<h3>Error Codes</h3>
<table>
<thead>
<tr>
<th>Code</th>
<th>Name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>-32700</td>
<td>Parse error</td>
<td>Invalid JSON</td>
</tr>
<tr>
<td>-32600</td>
<td>Invalid Request</td>
<td>Invalid JSON-RPC request</td>
</tr>
<tr>
<td>-32601</td>
<td>Method not found</td>
<td>Unknown method</td>
</tr>
<tr>
<td>-32602</td>
<td>Invalid params</td>
<td>Invalid method parameters</td>
</tr>
<tr>
<td>-32603</td>
<td>Internal error</td>
<td>Server internal error</td>
</tr>
<tr>
<td>-32000</td>
<td>Server error</td>
<td>Tool execution error</td>
</tr>
</tbody>
</table>
<h3>Tool-Specific Errors</h3>
<p>Tools return errors in content format:</p>
<pre><code class="language-json">{
  &quot;jsonrpc&quot;: &quot;2.0&quot;,
  &quot;id&quot;: 5,
  &quot;result&quot;: {
    &quot;content&quot;: [
      {
        &quot;type&quot;: &quot;text&quot;,
        &quot;text&quot;: &quot;Error: Repository path does not exist&quot;
      }
    ],
    &quot;isError&quot;: true
  }
}
</code></pre>
<h2>Logging and Debugging</h2>
<h3>Enable Protocol Logging</h3>
<pre><code class="language-bash">DEBUG=mcp:protocol npm run dev
</code></pre>
<h3>Message Tracing</h3>
<p>Log all MCP messages:</p>
<pre><code class="language-bash">DEBUG=mcp:* npm run dev
</code></pre>
<h3>Tool Execution Logging</h3>
<pre><code class="language-bash">DEBUG=documcp:tools npm run dev
</code></pre>
<h2>Advanced Protocol Features</h2>
<h3>Notifications</h3>
<p>documcp supports logging notifications:</p>
<pre><code class="language-json">{
  &quot;jsonrpc&quot;: &quot;2.0&quot;,
  &quot;method&quot;: &quot;notifications/message&quot;,
  &quot;params&quot;: {
    &quot;level&quot;: &quot;info&quot;,
    &quot;logger&quot;: &quot;documcp&quot;,
    &quot;data&quot;: &quot;Repository analysis completed&quot;
  }
}
</code></pre>
<h3>Progress Updates</h3>
<p>For long-running operations:</p>
<pre><code class="language-json">{
  &quot;jsonrpc&quot;: &quot;2.0&quot;,
  &quot;method&quot;: &quot;notifications/progress&quot;,
  &quot;params&quot;: {
    &quot;progressToken&quot;: &quot;analysis-123&quot;,
    &quot;progress&quot;: {
      &quot;kind&quot;: &quot;report&quot;,
      &quot;message&quot;: &quot;Analyzing dependencies...&quot;,
      &quot;percentage&quot;: 45
    }
  }
}
</code></pre>
<h2>Client Integration Examples</h2>
<h3>Claude Desktop Configuration</h3>
<pre><code class="language-json">{
  &quot;mcpServers&quot;: {
    &quot;documcp&quot;: {
      &quot;command&quot;: &quot;node&quot;,
      &quot;args&quot;: [&quot;/path/to/documcp/dist/index.js&quot;],
      &quot;env&quot;: {
        &quot;NODE_ENV&quot;: &quot;production&quot;
      }
    }
  }
}
</code></pre>
<h3>VS Code MCP Extension</h3>
<pre><code class="language-json">{
  &quot;mcp.servers&quot;: {
    &quot;documcp&quot;: {
      &quot;transport&quot;: &quot;stdio&quot;,
      &quot;command&quot;: &quot;node&quot;,
      &quot;args&quot;: [&quot;/path/to/documcp/dist/index.js&quot;]
    }
  }
}
</code></pre>
<h2>Protocol Testing</h2>
<h3>Manual Testing</h3>
<p>Test protocol handshake:</p>
<pre><code class="language-bash">echo '{&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;id&quot;: 1, &quot;method&quot;: &quot;initialize&quot;, &quot;params&quot;: {}}' | node dist/index.js
</code></pre>
<h3>Tool Testing</h3>
<p>Test specific tool:</p>
<pre><code class="language-bash">echo '{
  &quot;jsonrpc&quot;: &quot;2.0&quot;,
  &quot;id&quot;: 2,
  &quot;method&quot;: &quot;tools/call&quot;,
  &quot;params&quot;: {
    &quot;name&quot;: &quot;analyze_repository&quot;,
    &quot;arguments&quot;: {&quot;path&quot;: &quot;./test-repo&quot;}
  }
}' | node dist/index.js
</code></pre>
<h2>Performance Considerations</h2>
<h3>Message Size Limits</h3>
<ul>
<li>Maximum message size: 10MB</li>
<li>Large responses are chunked automatically</li>
<li>Binary data should be base64 encoded</li>
</ul>
<h3>Connection Management</h3>
<ul>
<li>Single stdio connection per client</li>
<li>Stateless tool execution</li>
<li>Connection pooling not applicable</li>
</ul>
<h3>Timeout Handling</h3>
<ul>
<li>Default tool timeout: 30 seconds</li>
<li>Configurable via environment variables</li>
<li>Graceful timeout with partial results</li>
</ul>
<h2>Security Considerations</h2>
<h3>Input Validation</h3>
<ul>
<li>All parameters validated with Zod schemas</li>
<li>Path traversal protection</li>
<li>File system access restrictions</li>
</ul>
<h3>Sandboxing</h3>
<ul>
<li>Tools run in isolated context</li>
<li>Limited file system access</li>
<li>No network access by default</li>
</ul>
<h3>Authentication</h3>
<ul>
<li>No authentication required for stdio transport</li>
<li>Client identity via initialization handshake</li>
<li>Optional API key support for future versions</li>
</ul>
